resources:
- repo: self

parameters:
- name: runCancel
  displayName: 'Want to cancel ran tests?'
  type: boolean
  default: false
- name: environment
  displayName: 'Environment to Test'
  type: string
  default: 'uat'
  values:
    - 'uat'
    - 'prod'
    - 'all'

variables:
  RUN_CANCEL: ${{ lower(format('{0}', parameters.runCancel)) }}
  SELECTED_ENVIRONMENT: ${{ parameters.environment }}

trigger:
- main

stages:
  - stage: RunTests
    displayName: Run Tests
    pool:
      vmImage: 'ubuntu-latest'
    jobs:
    - job: RunAllTests
      displayName: 'Execute Tests'
      strategy:
        matrix:
          ${{ if eq(parameters.environment, 'all') }}:
            all:
              ${{ if eq(parameters.runCancel, true) }}:
                TEST_SCRIPT: 'test:all:cancel'
              ${{ if eq(parameters.runCancel, false) }}:
                TEST_SCRIPT: 'test:all'
              ARTIFACT_NAME: playwright-report-all
          ${{ if eq(parameters.environment, 'uat') }}:
            uat:
              ${{ if eq(parameters.runCancel, true) }}:
                TEST_SCRIPT: 'test:uat:cancel'
              ${{ if eq(parameters.runCancel, false) }}:
                TEST_SCRIPT: 'test:uat'
              ARTIFACT_NAME: playwright-report-uat
          ${{ if eq(parameters.environment, 'prod') }}:
            prod:
              ${{ if eq(parameters.runCancel, true) }}:
                TEST_SCRIPT: 'test:prod:cancel'
              ${{ if eq(parameters.runCancel, false) }}:
                TEST_SCRIPT: 'test:prod'
              ARTIFACT_NAME: playwright-report-prod
        maxParallel: 2
      steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '18.x'
        displayName: 'Install Node.js'

      - script: |
          set -ex
          npm install
          npx playwright install
          npx playwright install-deps
        displayName: 'Install Playwright & Dependencies'
        workingDirectory: '$(Build.SourcesDirectory)'

      - script: |
          set -ex
          echo "Running tests for $(SELECTED_ENVIRONMENT) environment"
          npm run $(TEST_SCRIPT) --reporter=html
        displayName: 'Run $(SELECTED_ENVIRONMENT) Tests'
        workingDirectory: '$(Build.SourcesDirectory)'

      - publish: $(Build.SourcesDirectory)/playwright-report
        artifact: $(ARTIFACT_NAME)
        condition: always()