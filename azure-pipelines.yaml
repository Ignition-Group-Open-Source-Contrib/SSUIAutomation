resources:
- repo: self

trigger:
- main

stages:
  - stage: RunTests
    displayName: Run Tests on All Environments
    # variables:
    #   - group: 'MarketicAutomation variables-prd'  # Contains PROD_URL
    #   - group: 'MarketicAutomation variables-test'  # Contains UAT_URL
    pool:
      vmImage: 'ubuntu-latest'
    jobs:
    - job: RunAllTests
      displayName: 'Run Tests in Parallel'
      strategy:
        matrix:
          uat:
            ENV_NAME: 'UAT'
            TEST_SCRIPT: 'test:uat'
            BASE_URL: 'http://t2.silversurfer.ignitiongroup.co.za/Auth'
            ARTIFACT_NAME: 'playwright-report-uat'
          # prod:
          #   ENV_NAME: 'PROD'
          #   TEST_SCRIPT: 'test:prod'
          #   # BASE_URL: $(PROD_URL)
          #   ARTIFACT_NAME: 'playwright-report-prod'
        maxParallel: 2
      steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '16.x'
        displayName: 'Install Node.js'

      - script: |
          set -e
          npm install
          npx playwright install
          npx playwright install-deps
        displayName: 'Install dependencies'
        workingDirectory: '$(Build.SourcesDirectory)'

      - script: |
          set -e
          echo "Running tests for $(ENV_NAME) environment"
          echo "Base URL: $(BASE_URL)"
          npm run $(TEST_SCRIPT) || exit 1
        displayName: 'Run $(ENV_NAME) Tests'
        workingDirectory: '$(Build.SourcesDirectory)'
        env:
          BASE_URL: $(BASE_URL)
        failOnStderr: false

      - publish: $(System.DefaultWorkingDirectory)/playwright-report
        artifact: $(ARTIFACT_NAME)
        condition: always()